<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Target Zone ‚Äî Full Platform (Updated)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --glass: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.78);
      --accent: #10b981;
      --attempted: #10b981;
      --review: #f59e0b;
      --unattempted: #d1d5db;
      --card-border: rgba(255,255,255,0.10);
      --sun-glow: rgba(255,214,102,0.07);
    }
    body{
      font-family: 'Segoe UI', system-ui, -apple-system, "Noto Sans Bengali", sans-serif;
      margin:0; min-height:100vh;
      background:
        radial-gradient(circle at 12% 12%, var(--sun-glow) 0%, transparent 18%),
        radial-gradient(circle at 10% 10%, #1e3c72 0%, #2a5298 60%, #0f172a 100%);
      color: #fff;
      overflow-x:hidden;
    }
    main{ position:relative; z-index:10; padding-bottom:160px; max-width:1100px; margin:0 auto; }

    /* Unified card base */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.45);
      border: 1px solid var(--card-border);
    }
    .muted{ color:var(--muted); }
    header.sticky-top{ position:sticky; top:0; z-index:40; backdrop-filter: blur(6px); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1{ font-size:1.4rem; margin:0; font-weight:800; }

    /* Colored card border helpers */
    .card-bordered { border-left:6px solid var(--card-border); padding-left:12px; }
    .border-accent{ border-left-color: var(--accent); }
    .border-emerald{ border-left-color: #10b981; }
    .border-blue{ border-left-color: #2563eb; }
    .border-yellow{ border-left-color: #f59e0b; }
    .border-teal{ border-left-color: #06b6d4; }

    /* Dashboard / exam cards */
    #exam-cards{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin-top:12px; }
    .exam-card{
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:110px;
      justify-content:space-between;
      border:1px solid rgba(255,255,255,0.08);
      cursor:default;
      transition: transform .28s ease, box-shadow .28s ease;
      overflow:hidden;
      position:relative;
    }
    .exam-card:hover{ transform: translateY(-6px); box-shadow: 0 20px 40px rgba(2,6,23,0.55); }
    /* animation for empty spaces */
    .floating {
      position:absolute;
      right: -40px;
      top:-40px;
      width:140px;height:140px;
      border-radius:50%;
      opacity:0.06;
      animation: floaty 6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes floaty {
      0%{ transform: translateY(0) rotate(0deg); }
      50%{ transform: translateY(8px) rotate(7deg); }
      100%{ transform: translateY(0) rotate(0deg); }
    }
    /* give each exam-card a subtle unique background so it's obvious */
    .exam-card.bg-1{ background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); }
    .exam-card.bg-2{ background: linear-gradient(180deg, rgba(16,185,129,0.06), rgba(16,185,129,0.02)); }
    .exam-card.bg-3{ background: linear-gradient(180deg, rgba(37,99,235,0.04), rgba(37,99,235,0.02)); }
    .exam-card.bg-4{ background: linear-gradient(180deg, rgba(245,158,11,0.04), rgba(245,158,11,0.02)); }
    .exam-card h4{ margin:0; font-weight:800; font-size:1rem; display:flex; gap:8px; align-items:center; }
    .exam-card p{ margin:0; color:var(--muted); font-size:0.95rem; }

    /* horizontal layout for name + desc */
    .exam-card .top-row{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .exam-card .title-desc{ display:flex; gap:12px; align-items:center; flex:1; min-width:0; }
    .exam-card .desc { color:var(--muted); font-size:0.92rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* small round icon holder */
    .exam-icon{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:800; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); }

    /* Quiz area visuals */
    #quiz-section { padding: 18px; }
    #question-card { background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02)); border-radius:12px; padding:16px; box-shadow: 0 10px 30px rgba(2,6,23,0.45); border:1px solid var(--card-border); }
    #question-text { font-size:1.1rem; font-weight:700; margin-bottom:8px; color:#fff; word-break:break-word; }
    #options-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
    #options-list li {
      background: rgba(255,255,255,0.04);
      padding:12px;
      border-radius:10px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      border:1px solid rgba(255,255,255,0.06);
    }
    #options-list li input[type="radio"]{ transform:scale(1.05); pointer-events:none; } /* we handle clicks on li */
    #options-list li .opt-text{ flex:1; min-width:0; word-break:break-word; }

    /* Palette */
    #palette{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .palette-btn{ min-width:44px; min-height:44px; border-radius:8px; padding:6px 10px; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer; border:none; color: #0f172a; }
    .palette-un { background: var(--unattempted); color:#0f172a; }
    .palette-att { background: var(--attempted); color:white; }
    .palette-rev { background: var(--review); color:white; }
    .palette-legend{ display:flex; gap:14px; align-items:center; margin-top:8px; color:var(--muted); font-size:0.88rem; flex-wrap:wrap; }
    /* legend inside small bordered box to ensure it's inside view */
    .legend-box{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.04); }

    /* Submit button repositioned: center & fixed on small screens */
    .controls-row{ display:flex; gap:10px; align-items:center; margin-top:12px; }
    .controls-left{ display:flex; gap:8px; }
    #submit-btn{ background:#ef4444; color:white; padding:10px 18px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }

    /* On mobile make submit fixed bottom center */
    @media (max-width:640px){
      #submit-fixed{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; z-index:60; width:calc(100% - 40px); max-width:540px; display:flex; justify-content:center; }
    }

    /* Result simple card */
    #result-section .stat-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .stat { background: rgba(255,255,255,0.04); padding:12px; border-radius:8px; min-width:120px; text-align:center; border:1px solid rgba(255,255,255,0.06); }
    .stat .num{ font-size:1.4rem; font-weight:800; color:#fff; }
    .stat .label{ color:var(--muted); font-size:0.95rem; }

    /* Profile & leaderboard */
    #profile-section .profile-area{ display:grid; grid-template-columns: 1fr 320px; gap:14px; align-items:start; margin-top:12px; }
    @media (max-width:880px){
      #profile-section .profile-area{ grid-template-columns: 1fr; }
    }
    .profile-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
    .small-card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); }

    /* make clickable elements large on mobile */
    button, input, select{ touch-action:manipulation; }

    /* Profile greeting area in header becomes clickable profile card */
    #auth-ui { display:flex; gap:8px; align-items:center; cursor:pointer; }
    #auth-ui .greet { font-weight:700; color:#fff; }
    #auth-ui .greet-sub { color:var(--muted); font-size:0.95rem; }

    /* shrink font for palette legend on tight screens */
    @media (max-width:420px){
      .palette-legend{ font-size:0.78rem; gap:8px; }
    }
    button.start-btn {
  background: #2563eb; /* ‡¶®‡ßÄ‡¶≤ */
  color: #fff;
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}

button.start-btn:hover {
  background: #1d4ed8; /* ‡¶π‡ßã‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ó‡¶æ‡¶¢‡¶º ‡¶®‡ßÄ‡¶≤ */
}

button.start-btn:active {
  background: #1e40af; /* ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶∞‡ßã ‡¶ó‡¶æ‡¶¢‡¶º */
  transform: scale(0.96); /* ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶ö‡¶æ‡¶™‡¶æ effect */
                                             }
  </style>
</head>
<body>

  <header class="sticky-top card" role="banner">
    <div style="display:flex; align-items:center; gap:12px;">
      <h1>Target Zone</h1>
      <div class="muted" style="font-weight:600;">‚Äî Mock tests & analytics</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <!-- This greeting area acts as the profile-card (clickable) as requested -->
      <div id="auth-ui" role="button" aria-pressed="false" tabindex="0" title="‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®"></div>
    </div>
  </header>

  <main class="p-6">
    <!-- DASHBOARD -->
    <section id="dashboard" class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 style="font-size:1.25rem; margin:0; font-weight:800;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</h2>
          <p class="muted" style="margin-top:6px;">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® ‚Äî ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá Start ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®</p>
        </div>
        <!-- Removed separate 'Profile / History / Leaderboard' quick buttons as requested -->
      </div>

      <!-- Profile card simplified: header greeting is primary profile access -->
      <div style="margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div id="profile-card-dashboard" class="card card-bordered border-teal" role="button" tabindex="0" aria-pressed="false" style="display:flex; gap:12px; align-items:center; cursor:pointer;">
          <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.2rem; border:1px solid rgba(255,255,255,0.06);">
            <span id="dash-profile-initial">U</span>
          </div>
          <div class="meta">
            <div class="name" id="dash-profile-name">Guest</div>
            <div class="sub" id="dash-profile-sub">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‚Ä¢ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶∏‡¶π</div>
          </div>
        </div>
      </div>

      <div id="exam-cards" class="mt-4">
        <!-- JS injects cards -->
      </div>
    </section>

    <!-- QUIZ AREA -->
    <section id="quiz-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="back-to-dashboard" class="bg-white/6 px-2 py-1 rounded">‚Üê Back</button>
          <div>
            <h3 id="quiz-title" style="margin:0; font-weight:800;">Mock Test</h3>
            <div id="exam-tag" class="muted" style="font-size:0.95rem;">‚Äî</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="tts-toggle" class="bg-white/6 px-2 py-1 rounded">üîä Play Voice</button>
          <div id="timer" class="muted" style="background:rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px;">80:00</div>
        </div>
      </div>

      <div id="question-card" class="mt-4">
        <p id="question-text">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        <div id="difficulty-tag" class="muted" style="font-size:0.95rem;">Difficulty: -</div>

        <ul id="options-list" class="mt-4"></ul>

        <div class="controls-row" style="margin-top:14px; align-items:center;">
          <div class="controls-left">
            <!-- Order changed to: ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ -> ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï -> ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ (as requested) and placed inline / serialized -->
            <button id="prev-btn" class="bg-white/6 px-3 py-1 rounded">‚¨Ö ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
            <button id="mark-review-btn" class="bg-yellow-500 px-3 py-1 rounded text-white">üîñ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï</button>
            <button id="next-btn" class="bg-white/6 px-3 py-1 rounded">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚û°</button>
          </div>

          <div style="flex:1; margin-left:12px;">
            <div style="width:100%; background:rgba(255,255,255,0.06); height:10px; border-radius:8px; overflow:hidden;">
              <div id="progress-bar" style="width:0%; height:100%; background:var(--accent);"></div>
            </div>
          </div>

        </div>

        <!-- Palette + legend inside bordered small box -->
        <div id="palette" class="mt-4"></div>
        <div class="palette-legend" style="margin-top:8px;">
          <div class="legend-box">
            <div style="display:flex; gap:8px; align-items:center; font-size:0.86rem;">
              <div style="display:flex; gap:6px; align-items:center;">
                <div style="width:16px;height:16px;background:var(--attempted);border-radius:4px;"></div>
                <div style="font-size:0.86rem;">Attempted</div>
              </div>
              <div style="display:flex; gap:6px; align-items:center;">
                <div style="width:16px;height:16px;background:var(--review);border-radius:4px;"></div>
                <div style="font-size:0.86rem;">Review</div>
              </div>
              <div style="display:flex; gap:6px; align-items:center;">
                <div style="width:16px;height:16px;background:var(--unattempted);border-radius:4px;border:1px solid rgba(0,0,0,0.06);"></div>
                <div style="font-size:0.86rem;">Unattempted</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit button centered; small screens fixed via #submit-fixed -->
        <div id="submit-fixed" style="margin-top:14px;">
          <button id="submit-btn">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
        </div>

      </div>
    </section>

    <!-- RESULT / ANALYSIS (Pie chart replaces certificate) -->
    <section id="result-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">Result</h3>
        <div>
          <button id="close-result" class="bg-white/6 px-2 py-1 rounded">Close</button>
        </div>
      </div>

      <div class="stat-row" id="result-stats"></div>

      <div style="margin-top:12px; display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div style="flex:1; min-width:240px;">
          <canvas id="result-pie" style="max-width:480px;"></canvas>
        </div>
        <div id="result-note" class="muted" style="flex-basis:240px;">‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡ßá ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®, ‡¶ï‡¶§‡¶ü‡¶ø Attempted, Unattempted, Correct ‡¶è‡¶¨‡¶Ç Wrong ‚Äî ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶ø‡¶§ ‡¶π‡ßü‡•§</div>
      </div>
    </section>

    <!-- PROFILE / HISTORY / LEADERBOARD (combined view) -->
    <section id="profile-section" class="hidden card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-weight:800;">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ì ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ</h3>
        <div>
          <button id="logout-btn" class="bg-red-500 px-3 py-1 rounded text-white">Logout</button>
        </div>
      </div>

      <div class="profile-area">
        <!-- left: profile + history -->
        <div>
          <div class="profile-card" style="display:flex; gap:12px; align-items:center;">
            <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.2rem; border:1px solid rgba(255,255,255,0.06);">
              <span id="profile-initial">U</span>
            </div>
            <div style="flex:1;">
              <div id="profile-name" style="font-weight:800; font-size:1.05rem;">User</div>
              <div id="profile-email" class="muted" style="font-size:0.95rem; margin-top:4px;"></div>
              <div style="margin-top:10px;">
                <button id="edit-name-btn" class="bg-white/6 px-3 py-1 rounded">Name ‡¶¨‡¶¶‡¶≤‡¶æ‡¶®</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <h4 style="margin:6px 0 8px 0; font-weight:800;">Past Attempts</h4>
            <div id="past-attempts" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>

        <!-- right: summary + leaderboard compact -->
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="small-card">
            <div style="font-weight:700; font-size:0.95rem;">User Summary</div>
            <div id="user-summary" class="muted" style="margin-top:8px;">‚Äî</div>
          </div>

          <div class="small-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:700;">Leaderboard</div>
              <select id="leaderboard-exam" class="bg-white/6 px-2 py-1 rounded"></select>
            </div>
            <ul id="leaderboard-list" style="margin-top:12px; list-style:none; padding:0;"></ul>
          </div>
        </div>
      </div>
    </section>

  </main>

  <div style="padding: 0 1.5rem 1.5rem;">
    <footer id="site-footer" class="site-footer card" style="margin-top:18px; text-align:center;">
      üìå ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‚Äî SSC | Railways | TET | WB SET | WBJEE | Madhyamik ‚Äî ‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º
    </footer>
  </div>

  <!-- ============================
       Firebase + App Script (updated)
       ============================ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, addDoc, doc, setDoc, onSnapshot, updateDoc, getDoc, where, limit
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // exams
    const exams = [
      {id:"ssc", name:"SSC Exams", desc:"CGL, CHSL, GD, MTS", icon:"üìö"},
      {id:"railways", name:"Railways", desc:"NTPC, Group-D, JE", icon:"üöÜ"},
      {id:"tet", name:"TET Exams", desc:"Primary & Upper Primary", icon:"üè´"},
      {id:"wbset", name:"WB SET", desc:"Paper I & II", icon:"üéì"},
      {id:"wbjee", name:"WBJEE", desc:"Engineering & Medical", icon:"üß™"},
      {id:"madhyamik", name:"Madhyamik / HS", desc:"Board MCQ Practice", icon:"üìù"}
    ];

    // refs
    const examCards = document.getElementById("exam-cards");
    const dashboard = document.getElementById("dashboard");
    const quizSection = document.getElementById("quiz-section");
    const resultSection = document.getElementById("result-section");
    const profileSection = document.getElementById("profile-section");
    const authUi = document.getElementById("auth-ui");

    // initial UI render
    function renderExamCards(){
  examCards.innerHTML = exams.map((ex,i) => `
    <div class="exam-card bg-${(i%4)+1} card-bordered ${(i%4)==0? 'border-emerald': (i%4)==1? 'border-blue' : (i%4)==2? 'border-yellow' : 'border-accent'}" data-id="${ex.id}">
      <div class="floating" style="background: linear-gradient(45deg, rgba(255,255,255,0.04), rgba(0,0,0,0.02));"></div>
      <div class="top-row">
        <div class="title-desc">
          <div class="exam-icon">${ex.icon}</div>
          <div style="display:flex; flex-direction:column; min-width:0;">
            <h4 style="margin:0; font-weight:800;">${ex.name}</h4>
            <div class="desc muted">${ex.desc}</div>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
          <div class="muted" style="font-size:0.9rem;">Choose Subcategory</div>
          <div><button class="view-subcats" data-id="${ex.id}" style="background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;">View</button></div>
        </div>
      </div>
    </div>
  `).join("");
}
renderExamCards();
    async function loadSubcategories(categoryId){
  examCards.innerHTML = `<div class="muted">Loading ${categoryId} subcategories...</div>`;
  try {
    const q = query(collection(db, "subcategories"), where("category", "==", categoryId));
    const snap = await getDocs(q);

    if (snap.empty) {
      examCards.innerHTML = `<div class="muted">No subcategories found for ${categoryId}</div>`;
      return;
    }

    let html = "";
    let i=0;
    snap.forEach(docSnap=>{
      const sub = docSnap.data();
      html += `
        <div class="exam-card bg-${(i%4)+1} card-bordered ${(i%4)==0? 'border-emerald': (i%4)==1? 'border-blue' : (i%4)==2? 'border-yellow' : 'border-accent'}">
          <div class="floating" style="background: linear-gradient(45deg, rgba(255,255,255,0.04), rgba(0,0,0,0.02));"></div>
          <div class="top-row">
            <div class="title-desc">
              <div class="exam-icon">üìò</div>
              <div style="display:flex; flex-direction:column; min-width:0;">
                <h4 style="margin:0; font-weight:800;">${sub.name}</h4>
                <div class="desc muted">${categoryId} Subcategory</div>
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              <div class="muted" style="font-size:0.9rem;">MCQ Practice</div>
              <button class="start-exam start-btn" data-id="${categoryId}__${sub.id}">Start</button>
            </div>
          </div>
        </div>
      `;
      i++;
    });
    examCards.innerHTML = html;

    // back button
    const backBtn = document.createElement("button");
    backBtn.textContent = "‚Üê Back to Categories";
    backBtn.className = "bg-white/6 px-3 py-1 rounded mt-4";
    backBtn.onclick = renderExamCards;
    examCards.appendChild(backBtn);

  } catch(e){
    examCards.innerHTML = `<div class="muted">Error loading subcategories: ${e.message}</div>`;
  }
    }

    // app state
    let currentExam = null, questions = [], currentIndex = 0;
let autoSaveInterval = null;
    let answers = {}, reviewed = {}, timeLeft = 80*60, timerInterval = null;
    let currentUser = null;
    let ttsEnabled = false;
    let pieChartInstance = null;

    // auth UI rendering (header greeting acts as profile card)
    function renderAuthUI(){
      authUi.innerHTML = '';
      if (!currentUser) {
        authUi.innerHTML = `
          <div style="display:flex; flex-direction:column; align-items:flex-end;">
            <div class="greet">Sign In</div>
            <div class="greet-sub">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</div>
          </div>
        `;
        authUi.onclick = showSignIn;
        authUi.onkeydown = (e)=>{ if(e.key==='Enter'||e.key===' ') showSignIn(); };
      } else {
        const display = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'User');
        authUi.innerHTML = `
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1rem; border:1px solid rgba(255,255,255,0.06);">
              <span id="header-initial">${(display[0]||'U').toUpperCase()}</span>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
              <div class="greet">Hi, ${display}</div>
              <div class="greet-sub">${currentUser.email || ''}</div>
            </div>
          </div>
        `;
        // clicking header greeting opens profile combined view
        authUi.onclick = ()=> showSection('profile');
        authUi.onkeydown = (e)=> { if(e.key==='Enter'||e.key===' ') showSection('profile'); };
      }
    }

    function showSignUp(){
      const email = prompt("Email:");
      const pass = prompt("Password (6+):");
      const name = prompt("Name (shown on profile):");
      if (!email || !pass) return alert("Invalid");
      createUserWithEmailAndPassword(auth,email,pass)
        .then(async cred => {
          if (name) {
            try { await updateProfile(cred.user, { displayName: name }); } catch(e){}
          }
          alert("Registered & signed in");
        })
        .catch(err => alert(err.message));
    }
    function showSignIn(){
      const email = prompt("Email:");
      const pass = prompt("Password:");
      if (!email || !pass) return alert("Invalid");
      signInWithEmailAndPassword(auth,email,pass)
        .then(u => alert("Signed in"))
        .catch(err => alert(err.message));
    }

    // Dashboard profile card click opens profile combined view
    document.getElementById('profile-card-dashboard').addEventListener('click', ()=> showSection('profile'));
    document.getElementById('profile-card-dashboard').addEventListener('keydown', (e)=> { if(e.key==='Enter'||e.key===' ') showSection('profile'); });

    // History management & section navigation
    history.replaceState({section:'dashboard'}, '');

    function showSection(name, fromPop=false){
      dashboard.classList.toggle('hidden', name !== 'dashboard');
      quizSection.classList.toggle('hidden', name !== 'quiz');
      resultSection.classList.toggle('hidden', name !== 'result');
      profileSection.classList.toggle('hidden', name !== 'profile');

      if (!fromPop) {
        try { history.pushState({section:name}, ''); } catch(e){}
      }
    }

    window.addEventListener('popstate', (e)=>{
      const sec = (e.state && e.state.section) || 'dashboard';
      showSection(sec, true);
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      renderAuthUI();
      if (user) loadUserHistory();
      updateProfilePanel();
    });

    // start exam
    examCards.addEventListener('click', async (ev) => {
  const viewBtn = ev.target.closest('.view-subcats');
  if(viewBtn){
    const catId = viewBtn.dataset.id;
    loadSubcategories(catId);
    return;
  }
  const startBtn = ev.target.closest('.start-exam');
  if(startBtn){
    if (!auth.currentUser) return alert("Please sign in first.");
    const examId = startBtn.dataset.id;
    await startExam(examId);
    return;
  }
});

    async function startExam(examId){
  if (!auth.currentUser) return alert("Please sign in first.");
  currentExam = examId;
  questions = [];

  // üîç Check previous attempt; clear localStorage if already submitted
  try {
    const attemptRef = query(collection(db, 'results'),
      where('uid', '==', auth.currentUser.uid),
      where('exam', '==', examId),
      orderBy('submittedAt','desc'),
      limit(1)
    );
    const prevSnap = await getDocs(attemptRef);
    if (!prevSnap.empty) {
      const docData = prevSnap.docs[0].data();
      if (docData.submittedAt) {
        localStorage.removeItem(`${examId}_answers_${auth.currentUser.uid}`);
        localStorage.removeItem(`${examId}_review_${auth.currentUser.uid}`);
        localStorage.removeItem(`${examId}_time_${auth.currentUser.uid}`);
      }
    }
  } catch(e){ console.warn("Attempt check failed:", e); }

  // üß≠ Load questions
  try {
    let q;
    try { q = query(collection(db, examId), orderBy('id')); }
    catch (err) { q = query(collection(db, examId)); }
    const snap = await getDocs(q);
    if (snap.empty) return alert("No questions found in this exam.");
    questions = snap.docs.map(d => d.data());
  } catch(e){ console.error(e); return alert("Error loading questions."); }

  dashboard.classList.add('hidden');
  quizSection.classList.remove('hidden');
  document.getElementById('quiz-title').textContent = examId;
  document.getElementById('exam-tag').textContent = examId.toUpperCase();

  // Reset state
  answers = {}; reviewed = {}; currentIndex = 0;
  timeLeft = (questions.length * 60) || 80*60;

  // Resume unfinished attempt if localStorage has unsaved progress
  const savedAns = localStorage.getItem(`${examId}_answers_${auth.currentUser.uid}`);
  const savedRev = localStorage.getItem(`${examId}_review_${auth.currentUser.uid}`);
  const savedTime = localStorage.getItem(`${examId}_time_${auth.currentUser.uid}`);
  if (savedAns) {
    answers = JSON.parse(savedAns);
    reviewed = savedRev ? JSON.parse(savedRev) : {};
    timeLeft = savedTime ? parseInt(savedTime) : timeLeft;
    alert("‚ö° ‡¶Ö‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ Resume ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
  }

  renderQuestion();
  buildPalette();
  startTimer();

  // periodic autosave with proper reference
  if (typeof autoSaveInterval !== 'undefined' && autoSaveInterval) clearInterval(autoSaveInterval);
  autoSaveInterval = setInterval(() => {
    if (auth.currentUser && currentExam) {
      localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
      localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed));
      localStorage.setItem(`${currentExam}_time_${auth.currentUser.uid}`, timeLeft);
    }
  }, 5000);

  try { history.pushState({section:'quiz'}, ''); } catch(e){}
}
    function renderQuestion(){
      const q = questions[currentIndex] || { question: 'No question', options:[] };
      document.getElementById('question-text').textContent = `Q${currentIndex+1}: ${q.question}`;
      document.getElementById('difficulty-tag').textContent = `Difficulty: ${q.difficulty || 'N/A'} ‚Ä¢ Topic: ${q.topic || 'General'}`;

      const ol = document.getElementById('options-list');
      ol.innerHTML = '';
      (q.options || []).forEach((opt, idx)=>{
        const li = document.createElement('li');
        li.setAttribute('data-opt', opt);
        li.setAttribute('role','button');
        li.setAttribute('tabindex','0');

        const input = document.createElement('input');
        input.type='radio'; input.name='option'; input.value=opt;
        input.checked = (answers[currentIndex] === opt);

        input.onchange = () => {
          answers[currentIndex] = opt;
          // autosave silently per attempt (but not used to auto-restore at new exam start)
          if (auth.currentUser) {
            try {
              localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
              localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed));
            } catch(e){}
          }
          updatePalette(); updateProgress();
        };

        const spanText = document.createElement('span');
        spanText.className = 'opt-text';
        spanText.textContent = opt;

        li.appendChild(input);
        li.appendChild(spanText);

        li.addEventListener('click', (e)=>{
          input.checked = true;
          const ev = new Event('change', { bubbles: true });
          input.dispatchEvent(ev);
        });

        li.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles:true }));
          }
        });

        ol.appendChild(li);
      });
      updatePalette(); updateProgress();
      if (ttsEnabled) speakQuestion(questions[currentIndex]);
    }

    document.getElementById('back-to-dashboard').onclick = ()=> { showSection('dashboard'); };

    document.getElementById('prev-btn').onclick = ()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } };
    document.getElementById('next-btn').onclick = ()=>{ if(currentIndex<questions.length-1){ currentIndex++; renderQuestion(); } };
    document.getElementById('mark-review-btn').onclick = ()=>{ reviewed[currentIndex]=true; if (auth.currentUser) localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed)); updatePalette(); };

    // palette build & update
    function buildPalette(){
      const pal = document.getElementById('palette');
      pal.innerHTML = '';
      for(let i=0;i<questions.length;i++){
        const b = document.createElement('button');
        b.className = 'palette-btn palette-un';
        b.title = `Question ${i+1}`;
        b.innerText = `${i+1}`;
        b.onclick = ()=>{ currentIndex = i; renderQuestion(); };
        pal.appendChild(b);
      }
      updatePalette();
    }
    function updatePalette(){
      const children = [...document.getElementById('palette').children];
      children.forEach((btn,i)=>{
        btn.className = 'palette-btn palette-un';
        btn.innerText = `${i+1}`;
        if (answers[i]) { btn.classList.remove('palette-un'); btn.classList.add('palette-att'); btn.innerText = `${i+1} ‚úî`; btn.title = `Attempted ‚Ä¢ Q${i+1}`; }
        if (reviewed[i]) { btn.classList.remove('palette-att','palette-un'); btn.classList.add('palette-rev'); btn.innerText = `${i+1} ‚öë`; btn.title = `Marked for review ‚Ä¢ Q${i+1}`; }
      });
    }
    function updateProgress(){
      const attempted = Object.keys(answers).filter(k=>answers[k]).length;
      const percent = Math.round((attempted / questions.length)*100) || 0;
      document.getElementById('progress-bar').style.width = percent + '%';
    }

    // timer
    function startTimer(){
      if (timerInterval) clearInterval(timerInterval);
  if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; }
  try {
    localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
    localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
    localStorage.removeItem(`${currentExam}_time_${auth.currentUser.uid}`);
  } catch(e){}
      timerInterval = setInterval(()=>{
        if (timeLeft<=0){ clearInterval(timerInterval);
  if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; }
  try {
    localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
    localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
    localStorage.removeItem(`${currentExam}_time_${auth.currentUser.uid}`);
  } catch(e){} submitExam(); return; }
        timeLeft--;
        const m = Math.floor(timeLeft/60), s = timeLeft%60;
        document.getElementById('timer').textContent = `${m}:${String(s).padStart(2,'0')}`;
      },1000);
    }

    // submit -> compute counts -> save -> show pie chart result
    document.getElementById('submit-btn').onclick = ()=> {
      if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
      submitExam();
    };

    async function submitExam(){
      if (!auth.currentUser) { alert("Please sign in"); return; }
      let correct=0, wrong=0, unattempted=0, attempted=0;
      const topicMap = {};
      for(let i=0;i<questions.length;i++){
        const q = questions[i] || {};
        const given = answers[i];
        // Normalize values for safer comparison
        const norm = v => (typeof v === 'string' ? v.trim() : v);
        if (!given) { unattempted++; }
        else {
          attempted++;
          let isCorrect = false;
          // direct compare normalized
          if (norm(given) === norm(q.answer)) isCorrect = true;
          else {
            // if both exist in options, compare indices (safer for stray whitespace / unicode)
            if (Array.isArray(q.options)) {
              const optIdxGiven = q.options.findIndex(o => norm(o) === norm(given));
              const optIdxAnswer = q.options.findIndex(o => norm(o) === norm(q.answer));
              if (optIdxGiven !== -1 && optIdxAnswer !== -1 && optIdxGiven === optIdxAnswer) isCorrect = true;
            }
          }
          if (isCorrect) correct++;
          else { wrong++; const t = q.topic || 'General'; topicMap[t] = (topicMap[t]||0)+1; }
        }
      }
      const total = questions.length || 0;
      const percent = total ? Math.round((correct/total)*100) : 0;

      // save minimal result to Firestore (best-effort)
      try {
        await addDoc(collection(db,'results'), {
          uid: auth.currentUser.uid,
          email: auth.currentUser.email,
          displayName: auth.currentUser.displayName || null,
          exam: currentExam,
          score: correct,
          total,
          correct, wrong, unattempted,
          topicMap,
          submittedAt: new Date()
        });
      } catch(e){
        console.warn("Firestore save failed (maybe offline or rules):", e.message);
      }

      // clear local storage for this exam so a fresh attempt won't auto-restore
      try {
        localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
        localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
        localStorage.removeItem(`${currentExam}_time_${auth.currentUser.uid}`);
      } catch(e){}

      clearInterval(timerInterval);
  if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; }
  try {
    localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
    localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
    localStorage.removeItem(`${currentExam}_time_${auth.currentUser.uid}`);
  } catch(e){}

      // show result with pie chart
      showResultChart({correct, wrong, unattempted, attempted, total, percent});
      showDetailedResultTable(questions, answers);
    }

    function showResultChart(data){
      quizSection.classList.add('hidden');
      resultSection.classList.remove('hidden');

      const holder = document.getElementById('result-stats');
      holder.innerHTML = '';
      function statHtml(label, num){
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<div class="num">${num}</div><div class="label">${label}</div>`;
        return div;
      }
      holder.appendChild(statHtml('Total Questions', data.total));
      holder.appendChild(statHtml('Attempted', data.attempted));
      holder.appendChild(statHtml('Unattempted', data.unattempted));
      holder.appendChild(statHtml('Correct', data.correct));
      holder.appendChild(statHtml('Wrong', data.wrong));
      holder.appendChild(statHtml('Percentage', data.percent + '%'));

      // render pie chart
      const ctx = document.getElementById('result-pie').getContext('2d');
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Correct','Wrong','Unattempted'],
          datasets: [{
            data: [data.correct, data.wrong, data.unattempted],
            backgroundColor: ['#10b981','#ef4444','#d1d5db']
          }]
        },
        options: {
          responsive:true,
          plugins:{
            legend:{ position: 'bottom', labels:{color:'#fff'} },
            tooltip:{ callbacks:{ label: function(ctx){ return `${ctx.label}: ${ctx.parsed}`; } } }
          }
        }
      });

      try { history.pushState({section:'result'}, ''); } catch(e){}
    }
    function showDetailedResultTable(questions, answers) {
  const resultSec = document.getElementById('result-section');
  const div = document.createElement('div');
  div.innerHTML = `
    <h4 style="margin-top:20px; font-weight:800;">üìã ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h4>
    <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:0.95rem;">
      <thead>
        <tr style="background:rgba(255,255,255,0.08);">
          <th style="padding:8px; border:1px solid rgba(255,255,255,0.1); text-align:left;">#</th>
          <th style="padding:8px; border:1px solid rgba(255,255,255,0.1); text-align:left;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</th>
          <th style="padding:8px; border:1px solid rgba(255,255,255,0.1); text-align:left;">‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞</th>
          <th style="padding:8px; border:1px solid rgba(255,255,255,0.1); text-align:left;">‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞</th>
          <th style="padding:8px; border:1px solid rgba(255,255,255,0.1); text-align:center;">‡¶´‡¶≤‡¶æ‡¶´‡¶≤</th>
        </tr>
      </thead>
      <tbody id="result-details-body"></tbody>
    </table>
  `;

  const tbody = div.querySelector('#result-details-body');

  questions.forEach((q, i) => {
    const given = answers[i];
    const correct = q.answer || '‚Äî';
    const norm = v => (typeof v === 'string' ? v.trim().toLowerCase() : v);

    let statusIcon = '';
    let givenDisplay = '';

    if (!given || given.trim() === '') {
      statusIcon = '‚ö™';  // ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶Ø‡¶º‡¶®‡¶ø
      givenDisplay = '‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶Ø‡¶º‡¶®‡¶ø';
    } else if (norm(given) === norm(correct)) {
      statusIcon = '‚úÖ';  // ‡¶∏‡¶†‡¶ø‡¶ï
      givenDisplay = given;
    } else {
      statusIcon = '‚ùå';  // ‡¶≠‡ßÅ‡¶≤
      givenDisplay = given;
    }

    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
    tr.innerHTML = `
      <td style="padding:6px; vertical-align:top;">${i + 1}</td>
      <td style="padding:6px; vertical-align:top;">${q.question}</td>
      <td style="padding:6px; color:${statusIcon==='‚úÖ' ? '#10b981' : (statusIcon==='‚ùå' ? '#ef4444' : '#9ca3af')}; vertical-align:top;">${givenDisplay}</td>
      <td style="padding:6px; color:#22d3ee; vertical-align:top;">${correct}</td>
      <td style="padding:6px; text-align:center; vertical-align:top;">${statusIcon}</td>
    `;
    tbody.appendChild(tr);
  });

  resultSec.appendChild(div);
    }
    document.getElementById('close-result').onclick = ()=> {
      resultSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      try { history.pushState({section:'dashboard'}, ''); } catch(e){}
    };

    // leaderboard
    const lbExamSelect = document.getElementById('leaderboard-exam');
    lbExamSelect.innerHTML = exams.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    lbExamSelect.onchange = loadLeaderboard;
    async function loadLeaderboard(){
      const exam = lbExamSelect.value;
      const ul = document.getElementById('leaderboard-list');
      ul.innerHTML = '<li class="muted">Loading‚Ä¶</li>';
      try {
        const q = query(collection(db,'results'), where('exam','==',exam), orderBy('score','desc'), limit(20));
        const snap = await getDocs(q);
        ul.innerHTML = '';
        if (snap.empty) { ul.innerHTML = '<li class="muted">No results yet</li>'; return; }
        snap.forEach(d=>{
          const r = d.data();
          const li = document.createElement('li');
          li.style.marginBottom='8px';
          li.className = 'card';
          const name = r.displayName || (r.email ? r.email.split('@')[0] : 'User');
          li.innerText = `${name} ‚Äî ${r.score}/${r.total} ‚Äî ${new Date(r.submittedAt?.toDate?.() || r.submittedAt).toLocaleString()}`;
          ul.appendChild(li);
        });
      } catch(e){
        ul.innerHTML = `<li class="muted">Unable to load leaderboard</li>`;
      }
    }
    lbExamSelect.value = exams[0].id;
    loadLeaderboard();

    // user history & profile summary
    async function loadUserHistory(){
      if (!auth.currentUser) return;
      const q = query(collection(db,'results'), where('uid','==',auth.currentUser.uid), orderBy('submittedAt','asc'));
      try {
        const snap = await getDocs(q);
        const arr = snap.docs.map(d=>d.data());
        const container = document.getElementById('past-attempts'); container.innerHTML='';
        let totalAttempts = 0, bestPercent = 0;
        arr.forEach(r=>{
          totalAttempts++;
          const li = document.createElement('div');
          li.style.marginBottom='8px';
          li.className = 'small-card';
          const date = new Date(r.submittedAt?.toDate?.() || r.submittedAt);
          li.innerText = `${r.exam} ‚Äî ${r.score}/${r.total} ‚Äî ${date.toLocaleDateString()}`;
          container.appendChild(li);
          const p = Math.round((r.score / r.total)*100);
          if (p > bestPercent) bestPercent = p;
        });
        document.getElementById('user-summary').textContent = `Attempts: ${totalAttempts} ‚Ä¢ Best: ${bestPercent}%`;
      } catch(e){
        console.warn("history load failed:", e.message);
      }
      updateProfilePanel();
    }

    function updateProfilePanel(){
      const dashInitial = document.getElementById('dash-profile-initial');
      if (!currentUser) {
        document.getElementById('profile-name').textContent = 'Guest';
        document.getElementById('profile-email').textContent = '';
        document.getElementById('profile-initial').textContent = 'G';
        document.getElementById('dash-profile-name').textContent = 'Guest';
        document.getElementById('dash-profile-sub').textContent = '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‚Ä¢ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶∏‡¶π';
        dashInitial.textContent = 'G';
        renderAuthUI();
        return;
      }
      const name = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'User');
      document.getElementById('profile-name').textContent = name;
      document.getElementById('profile-email').textContent = currentUser.email || '';
      document.getElementById('profile-initial').textContent = (name[0] || 'U').toUpperCase();
      document.getElementById('dash-profile-name').textContent = name;
      document.getElementById('dash-profile-sub').textContent = currentUser.email || '';
      dashInitial.textContent = (name[0] || 'U').toUpperCase();
      renderAuthUI();
    }

    document.getElementById('logout-btn').onclick = ()=>{ signOut(auth); };

    // allow editing name (updates Firebase profile)
    document.getElementById('edit-name-btn').onclick = async ()=>{
      if (!auth.currentUser) return alert("Please sign in to change name.");
      const newName = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:", auth.currentUser.displayName || (auth.currentUser.email ? auth.currentUser.email.split('@')[0] : ''));
      if (!newName) return;
      try {
        await updateProfile(auth.currentUser, { displayName: newName });
        updateProfilePanel();
        alert("Name updated");
      } catch(e){ alert("Unable to update name: " + e.message); }
    };

    // tts
    document.getElementById('tts-toggle').onclick = ()=> {
      ttsEnabled = !ttsEnabled;
      document.getElementById('tts-toggle').innerText = ttsEnabled ? 'üîä Stop Voice' : 'üîä Play Voice';
      if (!ttsEnabled) speechSynthesis.cancel();
      else speakQuestion(questions[currentIndex]);
    };
    function speakQuestion(q){
      if (!q || !ttsEnabled) return;
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance();
      utter.lang = 'bn-BD';
      utter.text = `‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${q.question}. `;
      (q.options || []).forEach((opt,i)=>{ utter.text += `‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ${i+1}: ${opt}. `; });
      speechSynthesis.speak(utter);
    }

    // autosave on unload (still saves but we DO NOT auto-restore on new attempts)
    window.addEventListener('beforeunload', ()=>{
      if (currentExam && auth.currentUser) {
        try {
          localStorage.setItem(`${currentExam}_answers_${auth.currentUser.uid}`, JSON.stringify(answers));
          localStorage.setItem(`${currentExam}_review_${auth.currentUser.uid}`, JSON.stringify(reviewed));
        } catch(e){}
      }
    });

    // initial UI
    renderAuthUI();
    // üîÑ Handle mobile/system back to fully reset state
window.onpopstate = function(event) {
  if (event.state && event.state.section === 'dashboard') {
    currentExam = null;
    answers = {};
    reviewed = {};
    timeLeft = 0;
    if (autoSaveInterval) {
      clearInterval(autoSaveInterval);
      autoSaveInterval = null;
    }
    try {
      if (auth.currentUser && currentExam) {
        localStorage.removeItem(`${currentExam}_answers_${auth.currentUser.uid}`);
        localStorage.removeItem(`${currentExam}_review_${auth.currentUser.uid}`);
        localStorage.removeItem(`${currentExam}_time_${auth.currentUser.uid}`);
      }
    } catch(e){ console.warn("back-reset failed", e); }
    console.log("‚úÖ State reset due to back navigation");
  }
};

  </script>
</body>
</html>
