<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Dashboard - Target Zone</title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* Floating Background Glow */
body {
    margin: 0;
    padding: 20px;
    background: radial-gradient(circle at top, #dbeafe, #e0f2fe, #ffffff);
    font-family: "Inter", sans-serif;
    overflow-x: hidden;
}

.light {
    position: fixed;
    width: 350px;
    height: 350px;
    filter: blur(120px);
    border-radius: 50%;
    z-index: -1;
    animation: float 8s infinite alternate ease-in-out;
}
.light1 { background: rgba(99,102,241,0.25); top:10%; left:5%; }
.light2 { background: rgba(236,72,153,0.25); top:30%; left:60%; }
.light3 { background: rgba(14,165,233,0.25); top:70%; left:20%; }

@keyframes float {
    from { transform: translateY(0px); }
    to { transform: translateY(40px); }
}

/* Glass Card */
.glass-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.sec-title {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 12px;
    background: linear-gradient(90deg,#4f46e5,#9333ea);
    -webkit-background-clip: text;
    color: transparent;
}

/* Exam Button */
.examBtn {
    background: linear-gradient(90deg,#4f46e5,#9333ea);
    color: white;
    padding: 12px;
    width: 100%;
    border-radius: 14px;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 8px 18px rgba(99,102,241,0.3);
}

/* Payment Table */
.table-box { overflow-x: auto; }
th {
    padding: 10px;
    background: #4f46e5;
    color: white;
    font-weight: 700;
}
td {
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
}

/* Email-linking box */
#linkBox {
    background: rgba(255,255,255,0.85);
    padding: 25px;
    border-radius: 22px;
    box-shadow: 0 15px 28px rgba(0,0,0,0.15);
}
</style>

</head>
<body>

<!-- BG Lights -->
<div class="light light1"></div>
<div class="light light2"></div>
<div class="light light3"></div>

<div class="max-w-5xl mx-auto">

<h1 class="text-4xl font-extrabold mb-6 text-center"
 style="background:linear-gradient(90deg,#4f46e5,#9333ea);-webkit-background-clip:text;color:transparent;">
 üéì Student Dashboard
</h1>

<!-- *******************************
     EMAIL LOGIN ‚Äî LINK BOX
******************************** -->
<div id="linkBox" class="hidden mb-6">
    <h2 class="text-2xl font-bold mb-3 text-indigo-700">üîó ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ Phone + DOB ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</h2>

    <input id="linkPhone" class="w-full p-3 border rounded-lg mb-3" placeholder="Phone Number">
    <input id="linkDob" class="w-full p-3 border rounded-lg mb-3" placeholder="DOB (YYYY-MM-DD)">

    <button id="submitLink" class="examBtn">Link Account</button>
</div>

<!-- *******************************
     STUDENT INFO
******************************** -->
<div id="infoSection" class="glass-card hidden mb-6">
    <h2 class="sec-title">üìå ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p><strong>‡¶®‡¶æ‡¶Æ:</strong> <span id="name"></span></p>
        <p><strong>‡¶´‡ßã‡¶®:</strong> <span id="phone"></span></p>
        <p><strong>‡¶ú‡¶®‡ßç‡¶Æ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="dob"></span></p>
        <p><strong>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="father"></span></p>
        <p><strong>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö:</strong> <span id="batch"></span></p>
        <p><strong>‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™:</strong> <span id="whatsapp"></span></p>
    </div>
</div>

<!-- *******************************
     PAYMENT HISTORY
******************************** -->
<div id="paymentSection" class="glass-card hidden mb-6">
    <h2 class="sec-title">üí∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>

    <div class="table-box">
        <table class="w-full">
            <thead>
                <tr>
                    <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                    <th>‡¶Æ‡¶æ‡¶∏</th>
                    <th>‡¶ü‡¶æ‡¶ï‡¶æ</th>
                </tr>
            </thead>
            <tbody id="paymentTable"></tbody>
        </table>
    </div>
</div>

<!-- *******************************
     EXAM SECTION ‚Üí quiz.html Redirect
******************************** -->
<div id="examSection" class="glass-card hidden mb-6">
    <h2 class="sec-title">üìù Exam</h2>

    <a href="quiz.html">
        <button class="examBtn">Go to Exam Page</button>
    </a>
</div>

</div>

<!-- Firebase + JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
    getFirestore, doc, getDoc, collection, getDocs, updateDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
    authDomain: "target-zone-8fffd.firebaseapp.com",
    projectId: "target-zone-8fffd",
    storageBucket: "target-zone-8fffd.appspot.com",
    messagingSenderId: "667579216123",
    appId: "1:667579216123:web:37bb1fcc724743073d005e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


/* ------------------------------
   CHECK LOGIN STATE
-------------------------------- */
onAuthStateChanged(auth, async (user) => {

    const sid = localStorage.getItem("studentId");

    // PHONE LOGIN ‚Üí Already have studentId
    if (sid) {
        loadDashboard(sid);
        return;
    }

    // EMAIL LOGIN ‚Üí Need linking
    if (!user) return;

    const q = query(collection(db, "students"), where("linkedEmail", "==", user.email));
    const snap = await getDocs(q);

    if (!snap.empty) {
        const id = snap.docs[0].id;
        localStorage.setItem("studentId", id);
        loadDashboard(id);
    } else {
        document.getElementById("linkBox").classList.remove("hidden");
    }
});

/* ------------------------------
   LINK EMAIL ‚Üí PHONE + DOB
-------------------------------- */
document.getElementById("submitLink").onclick = async () => {

    const phone = linkPhone.value.trim();
    const dob = linkDob.value.trim();
    const user = auth.currentUser;

    const q = query(
        collection(db, "students"),
        where("phone", "==", phone),
        where("dob", "==", dob)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
        Swal.fire("Error", "‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "error");
        return;
    }

    const ref = snap.docs[0].ref;
    await updateDoc(ref, { linkedEmail: user.email });

    localStorage.setItem("studentId", snap.docs[0].id);

    Swal.fire("Success", "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!", "success");
    setTimeout(()=> location.reload(), 800);
};

/* ------------------------------
   LOAD DASHBOARD
-------------------------------- */
async function loadDashboard(id) {

    const ref = doc(db, "students", id);
    const snap = await getDoc(ref);

    const d = snap.data();

    name.textContent = d.name;
    phone.textContent = d.phone;
    dob.textContent = d.dob;
    father.textContent = d.father;
    batch.textContent = d.batch;
    whatsapp.textContent = d.whatsapp;

    infoSection.classList.remove("hidden");
    paymentSection.classList.remove("hidden");
    examSection.classList.remove("hidden");

    // Load Payments
    const payRef = collection(db, "students", id, "payments");
    const paySnap = await getDocs(payRef);

    let html = "";
    paySnap.forEach(doc => {
        let p = doc.data();
        html += `
        <tr>
            <td>${p.date}</td>
            <td>${p.month}</td>
            <td>${p.amount} ‡¶ü‡¶æ‡¶ï‡¶æ</td>
        </tr>
        `;
    });

    document.getElementById("paymentTable").innerHTML = html;
}
</script>

</body>
</html>
