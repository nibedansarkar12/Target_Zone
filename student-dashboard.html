<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Dashboard - Target Zone (Secure)</title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body { margin: 0; padding: 20px; background: radial-gradient(circle at top, #dbeafe, #e0f2fe, #ffffff); font-family: "Inter", sans-serif; }
.light { position: fixed; width: 350px; height: 350px; filter: blur(120px); border-radius: 50%; z-index:-1; animation: float 8s infinite alternate ease-in-out; }
.light1 { background: rgba(99,102,241,0.25); top:10%; left:5%; }
.light2 { background: rgba(236,72,153,0.25); top:30%; left:60%; }
.light3 { background: rgba(14,165,233,0.25); top:70%; left:20%; }
@keyframes float { from { transform: translateY(0px); } to { transform: translateY(40px);} }
.glass-card { background: rgba(255,255,255,0.72); backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
.sec-title { font-size: 26px; font-weight: 800; margin-bottom: 12px; background: linear-gradient(90deg,#4f46e5,#9333ea); -webkit-background-clip: text; color: transparent; }
.table-box { overflow-x: auto; } th { background:#4f46e5; color:white; padding:10px; } td { padding:10px; border-bottom:1px solid #e5e7eb; }
.examBtn { background: linear-gradient(90deg,#4f46e5,#9333ea); color:white; padding:12px; width:100%; font-size:18px; border-radius:14px; font-weight:700; box-shadow:0 8px 18px rgba(99,102,241,0.3); }
.logoutBtn { background:#ef4444; color:white; padding:8px 12px; border-radius:10px; font-weight:700; }
</style>
</head>
<body>

<div class="light light1"></div>
<div class="light light2"></div>
<div class="light light3"></div>

<div class="max-w-5xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-4xl font-extrabold" style="background:linear-gradient(90deg,#4f46e5,#9333ea);-webkit-background-clip:text;color:transparent;"> üéì Student Dashboard</h1>
    <div>
      <button id="btnLogout" class="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- STUDENT INFO -->
  <div id="infoSection" class="glass-card hidden mb-6">
      <h2 class="sec-title">üìå ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <p><strong>‡¶®‡¶æ‡¶Æ:</strong> <span id="name"></span></p>
          <p><strong>‡¶´‡ßã‡¶®:</strong> <span id="phone"></span></p>
          <p><strong>‡¶ú‡¶®‡ßç‡¶Æ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="dob"></span></p>
          <p><strong>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="father"></span></p>
          <p><strong>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö:</strong> <span id="batch"></span></p>
          <p><strong>‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™:</strong> <span id="whatsapp"></span></p>
      </div>
  </div>

  <!-- PAYMENTS -->
  <div id="paymentSection" class="glass-card hidden mb-6">
      <h2 class="sec-title">üí∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>
      <div class="table-box">
          <table class="w-full">
              <thead>
                  <tr>
                      <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                      <th>‡¶Æ‡¶æ‡¶∏</th>
                      <th>‡¶ü‡¶æ‡¶ï‡¶æ</th>
                  </tr>
              </thead>
              <tbody id="paymentTable"></tbody>
          </table>
      </div>
  </div>

  <!-- Exam -->
  <div id="examSection" class="glass-card hidden mb-6">
      <h2 class="sec-title">üìù Exam</h2>
      <a href="quiz.html"><button class="examBtn">Go to Exam Page</button></a>
  </div>
</div>

<script type="module" defer>
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
      authDomain: "target-zone-8fffd.firebaseapp.com",
      projectId: "target-zone-8fffd",
      storageBucket: "target-zone-8fffd.appspot.com",
      messagingSenderId: "667579216123",
      appId: "1:667579216123:web:37bb1fcc724743073d005e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // get SID from URL
  const url = new URL(window.location.href);
  const sid = url.searchParams.get("sid");
  console.log("SID Received =", sid);

  // utility signOut + redirect
  async function doSignOutAndRedirect(msg) {
    try { await signOut(auth); } catch(e){ console.warn("signOut error", e); }
    if (msg) Swal.fire("Notice", msg, "info");
    setTimeout(() => location.href = "login.html", 800);
  }

  // AUTH guard
  let currentStudentDocId = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // not logged in
      console.warn("No auth user ‚Äî redirecting to login");
      location.href = "login.html";
      return;
    }

    try {
      console.log("Auth user present:", user.uid, user.email);

      // Try to find student by authUid
      let studentDoc = null;

      // 1) find by authUid
      const q1 = query(collection(db, "students"), where("authUid", "==", user.uid));
      const snap1 = await getDocs(q1);
      if (!snap1.empty) {
        studentDoc = snap1.docs[0];
      } else if (user.email) {
        // 2) fallback: find by email
        const q2 = query(collection(db, "students"), where("email", "==", user.email));
        const snap2 = await getDocs(q2);
        if (!snap2.empty) studentDoc = snap2.docs[0];
      }

      if (!studentDoc) {
        // no matching student doc for this auth user
        console.error("No student document linked with this auth user");
        await doSignOutAndRedirect("‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡•§");
        return;
      }

      const foundId = studentDoc.id;
      currentStudentDocId = foundId;

      console.log("Mapped studentDocId:", foundId, "URL sid:", sid);

      // SID must be present and match
      if (!sid || sid !== foundId) {
        // mismatch ‚Äî block access
        console.warn("SID missing or mismatch -> blocking");
        await doSignOutAndRedirect("Access denied (SID mismatch) ‚Äî ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      // fetch document fresh (though we already have studentDoc)
      const ref = doc(db, "students", foundId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await doSignOutAndRedirect("Student data not found!");
        return;
      }

      const d = snap.data();
      // fill UI
      document.getElementById("name").textContent = d.name || "-";
      document.getElementById("phone").textContent = d.phone || "-";
      document.getElementById("dob").textContent = d.dob || "-";
      document.getElementById("father").textContent = d.father || "-";
      document.getElementById("batch").textContent = d.batch || "-";
      document.getElementById("whatsapp").textContent = d.whatsapp || "-";

      document.getElementById("infoSection").classList.remove("hidden");

      // load payments subcollection
      const payRef = collection(db, "students", foundId, "payments");
      const paySnap = await getDocs(payRef);
      let html = "";
      paySnap.forEach(doc => {
        const p = doc.data();
        html += `<tr><td>${p.date || "-"}</td><td>${p.month || "-"}</td><td>${p.amount || "-"} ‡¶ü‡¶æ‡¶ï‡¶æ</td></tr>`;
      });
      document.getElementById("paymentTable").innerHTML = html;
      document.getElementById("paymentSection").classList.remove("hidden");
      document.getElementById("examSection").classList.remove("hidden");

    } catch (err) {
      console.error("Error in auth state handler:", err);
      await doSignOutAndRedirect("Error loading dashboard ‚Äî ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
    }
  });

  // logout button
  document.getElementById("btnLogout").addEventListener("click", async () => {
    await signOut(auth);
    location.href = "login.html";
  });

</script>
</body>
</html>
