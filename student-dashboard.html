<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Dashboard - Target Zone</title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* Premium Glass Background */
body {
    background: linear-gradient(180deg,#c7f0ff,#eaf7ff,#ffffff);
    min-height: 100vh;
    padding: 20px;
    font-family: "Inter", sans-serif;
}

.glass-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.table-box { overflow-x: auto; }

th {
    background: #4f46e5;
    color: white;
    padding: 10px;
    font-weight: 700;
}
td {
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
}

/* Linking Box */
#linkBox {
    background: #ffffffaa;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}
</style>

</head>
<body>

<div class="max-w-5xl mx-auto">

<h1 class="text-4xl font-bold text-indigo-700 text-center mb-6">ЁЯОУ Student Dashboard</h1>

<!-- UID Linking Box (for Email Login Users) -->
<div id="linkBox" class="hidden mb-5">
    <h2 class="text-2xl font-semibold mb-3">ЁЯФЧ ржкрзНрж░ржержоржмрж╛рж░ ржЖржкржирж╛рж░ ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯ рж▓рж┐ржВржХ ржХрж░рзБржи</h2>
    <p class="mb-3 text-gray-700">ржЖржкржирж╛рж░ ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░ ржПржмржВ ржЬржирзНржорждрж╛рж░рж┐ржЦ ржжрж┐ржи (Phone + DOB)</p>

    <input id="linkPhone" type="text" placeholder="ржлрзЛржи ржиржорзНржмрж░" class="w-full mb-3 p-3 border rounded-lg">
    <input id="linkDob" type="text" placeholder="ржЬржирзНржорждрж╛рж░рж┐ржЦ (YYYY-MM-DD)" class="w-full mb-3 p-3 border rounded-lg">

    <button id="linkSubmit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold">
        Submit & Link Account
    </button>
</div>

<!-- Student Info -->
<div id="infoSection" class="glass-card mb-6 hidden">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">ржмрзНржпржХрзНрждрж┐ржЧржд рждржерзНржп</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p><strong>ржирж╛ржо:</strong> <span id="name"></span></p>
        <p><strong>ржлрзЛржи:</strong> <span id="phone"></span></p>
        <p><strong>ржЬржирзНржорждрж╛рж░рж┐ржЦ:</strong> <span id="dob"></span></p>
        <p><strong>ржкрж┐рждрж╛рж░ ржирж╛ржо:</strong> <span id="father"></span></p>
        <p><strong>ржмрзНржпрж╛ржЪ:</strong> <span id="batch"></span></p>
        <p><strong>рж╣рзЛржпрж╝рж╛ржЯрж╕ржЕрзНржпрж╛ржк:</strong> <span id="whatsapp"></span></p>
    </div>
</div>

<!-- Payments -->
<div id="paymentSection" class="glass-card hidden">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">ЁЯТ░ ржкрзЗржорзЗржирзНржЯ рж╣рж┐рж╕рзНржЯрж░рж┐</h2>

    <div class="table-box">
        <table class="w-full text-left">
            <thead>
                <tr>
                    <th>рждрж╛рж░рж┐ржЦ</th>
                    <th>ржорж╛рж╕</th>
                    <th>ржЯрж╛ржХрж╛</th>
                </tr>
            </thead>
            <tbody id="paymentTable"></tbody>
        </table>
    </div>
</div>

</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
    getFirestore, doc, getDoc, collection, getDocs, updateDoc, query, where 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
    authDomain: "target-zone-8fffd.firebaseapp.com",
    projectId: "target-zone-8fffd",
    storageBucket: "target-zone-8fffd.appspot.com",
    messagingSenderId: "667579216123",
    appId: "1:667579216123:web:37bb1fcc724743073d005e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// CHECK LOGIN METHOD
onAuthStateChanged(auth, async (user) => {

    const localId = localStorage.getItem("studentId");

    if (localId) {
        // PHONE LOGIN
        loadDashboard(localId);
        return;
    }

    if (!user) return;

    // Email Login тЖТ Check if Linked
    const q = query(collection(db, "students"), where("linkedEmail", "==", user.email));
    const snap = await getDocs(q);

    if (!snap.empty) {
        const docId = snap.docs[0].id;
        localStorage.setItem("studentId", docId);
        loadDashboard(docId);
    } else {
        // Show linking box
        document.getElementById("linkBox").classList.remove("hidden");
    }
});

// Linking System for Email Login
document.getElementById("linkSubmit").onclick = async () => {
    const phone = linkPhone.value.trim();
    const dob = linkDob.value.trim();
    const user = auth.currentUser;

    if (!phone || !dob) {
        Swal.fire("Error", "ржлрзЛржи ржПржмржВ ржЬржирзНржорждрж╛рж░рж┐ржЦ ржжрж┐ржи", "error");
        return;
    }

    const q = query(
        collection(db, "students"),
        where("phone", "==", phone),
        where("dob", "==", dob)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
        Swal.fire("Error", "ржорж┐рж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐!", "error");
        return;
    }

    // update doc with email link
    const ref = snap.docs[0].ref;
    await updateDoc(ref, { linkedEmail: user.email });

    localStorage.setItem("studentId", snap.docs[0].id);

    Swal.fire("Success", "ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯ рж▓рж┐ржВржХ рж╕ржлрж▓!", "success");
    setTimeout(() => location.reload(), 800);
};


// LOAD DASHBOARD
async function loadDashboard(id) {

    // load student info
    const ref = doc(db, "students", id);
    const snap = await getDoc(ref);

    if (!snap.exists()) return;

    const d = snap.data();

    document.getElementById("name").textContent = d.name;
    document.getElementById("phone").textContent = d.phone;
    document.getElementById("dob").textContent = d.dob;
    document.getElementById("father").textContent = d.father;
    document.getElementById("batch").textContent = d.batch;
    document.getElementById("whatsapp").textContent = d.whatsapp;

    document.getElementById("infoSection").classList.remove("hidden");

    // load payments
    const payRef = collection(db, "students", id, "payments");
    const paySnap = await getDocs(payRef);

    let html = "";
    paySnap.forEach(doc => {
        let p = doc.data();
        html += `
            <tr>
                <td>${p.date || "-"}</td>
                <td>${p.month || "-"}</td>
                <td>${p.amount || 0} ржЯрж╛ржХрж╛</td>
            </tr>
        `;
    });

    document.getElementById("paymentTable").innerHTML = html;
    document.getElementById("paymentSection").classList.remove("hidden");
}
</script>

</body>
</html>
