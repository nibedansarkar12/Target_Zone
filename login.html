<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Target Zone ‚Äî Login (Secure)</title>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{ --accent1:#6d28d9; --accent2:#8b5cf6; }
    body{ font-family:"Inter",sans-serif; background:linear-gradient(180deg,#c7f0ff,#eaf7ff,#f6fbff); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:30px; }
    .card{ width:100%; max-width:900px; display:flex; gap:30px; padding:30px; background:rgba(255,255,255,0.85); backdrop-filter:blur(10px); box-shadow:0 20px 40px rgba(0,0,0,0.12); border-radius:20px; z-index:10; }
    .logo-img{ max-width:180px; max-height:180px; object-fit:contain; border-radius:12px; }
    .pill{ padding:8px 15px; border-radius:999px; cursor:pointer; font-weight:600; }
    .pill.active{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; box-shadow:0 8px 20px rgba(99,102,241,0.18); }
    .input{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.15); background:white; font-size:15px; }
    .action-btn{ width:100%; padding:12px; border-radius:12px; color:white; font-size:16px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); font-weight:700; }
    .relative{ position:relative; }
    .absolute{ position:absolute; right:1rem; top:0.6rem; cursor:pointer; }
  </style>
</head>
<body>

  <div class="card">
    <div class="flex justify-center items-center w-full">
      <img class="logo-img" src="https://raw.githubusercontent.com/nibedansarkar12/Target_Zone/main/target-zone-high-resolution-logo-black.png">
    </div>

    <div class="w-full">
      <h2 class="text-2xl font-bold text-gray-800 mb-3">Target Zone ‚Äî Login</h2>

      <div class="flex gap-3 mb-4">
        <div id="pillUID" class="pill active">Phone Login</div>
        <div id="pillEmail" class="pill">Email Login</div>
      </div>

      <!-- PHONE -->
      <div id="formUID">
        <input id="inputPhone" class="input mb-3" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 01701234567)">
        <div class="relative mb-3">
          <input id="inputDob" class="input pr-10" type="password" placeholder="‡¶ú‡¶®‡ßç‡¶Æ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (YYYY-MM-DD)">
          <span id="toggleDob" class="absolute">üëÅÔ∏è</span>
        </div>
        <button id="btnPhoneLogin" class="action-btn mb-2">Login</button>
      </div>

      <!-- EMAIL -->
      <div id="formEmail" class="hidden">
        <input id="inputEmail" class="input mb-3" type="email" placeholder="Email ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        <div class="relative mb-3">
          <input id="inputEmailPass" class="input pr-10" type="password" placeholder="Password">
          <span id="toggleEmailPass" class="absolute">üëÅÔ∏è</span>
        </div>
        <button id="btnEmailLogin" class="action-btn mb-2">Login with Email</button>
      </div>

      <div class="my-4">
        <button id="btnGoogle" class="w-full flex items-center justify-center gap-3 py-2 border rounded-lg bg-white">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
          Sign in with Google
        </button>
      </div>

      <div class="flex justify-between mt-2">
        <a href="signup.html" class="text-indigo-600 text-sm">‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®</a>
        <a href="admin-login.html" class="text-gray-600 text-sm">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</a>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
    authDomain: "target-zone-8fffd.firebaseapp.com",
    projectId: "target-zone-8fffd",
    storageBucket: "target-zone-8fffd.appspot.com",
    messagingSenderId: "667579216123",
    appId: "1:667579216123:web:37bb1fcc724743073d005e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elements
  const pillUID = document.getElementById("pillUID");
  const pillEmail = document.getElementById("pillEmail");
  const formUID = document.getElementById("formUID");
  const formEmail = document.getElementById("formEmail");
  const toggleDob = document.getElementById("toggleDob");
  const toggleEmailPass = document.getElementById("toggleEmailPass");

  pillUID.onclick = () => {
    pillUID.classList.add("active");
    pillEmail.classList.remove("active");
    formUID.classList.remove("hidden");
    formEmail.classList.add("hidden");
  };
  pillEmail.onclick = () => {
    pillEmail.classList.add("active");
    pillUID.classList.remove("active");
    formEmail.classList.remove("hidden");
    formUID.classList.add("hidden");
  };

  toggleDob.onclick = () => {
    const inputDob = document.getElementById("inputDob");
    inputDob.type = inputDob.type === "password" ? "text" : "password";
  };
  toggleEmailPass.onclick = () => {
    const inputEmailPass = document.getElementById("inputEmailPass");
    inputEmailPass.type = inputEmailPass.type === "password" ? "text" : "password";
  };

  // PHONE + DOB login
  document.getElementById("btnPhoneLogin").onclick = async () => {
    const phone = document.getElementById("inputPhone").value.trim();
    const dob = document.getElementById("inputDob").value.trim();

    if (!phone || !dob) {
      Swal.fire("Error", "‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ì ‡¶ú‡¶®‡ßç‡¶Æ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡¶ø‡¶®", "error");
      return;
    }

    try {
      // find student doc by phone & dob
      const q = query(collection(db, "students"), where("phone", "==", phone), where("dob", "==", dob));
      const snap = await getDocs(q);

      if (snap.empty) {
        Swal.fire("Login Failed", "‡¶≠‡ßÅ‡¶≤ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶ú‡¶®‡ßç‡¶Æ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ", "error");
        return;
      }

      const studentDoc = snap.docs[0];
      const studentId = studentDoc.id;

      // create auth session -> anonymous
      const anonRes = await signInAnonymously(auth);

      // update student document with authUid (so dashboard can map)
      const uid = anonRes.user.uid;
      await updateDoc(doc(db, "students", studentId), { authUid: uid });

      Swal.fire("Success", "Login Successful!", "success");
      setTimeout(() => {
        location.href = `student-dashboard.html?sid=${studentId}`;
      }, 800);

    } catch (err) {
      console.error(err);
      Swal.fire("Error", err.message || "Something went wrong", "error");
    }
  };

  // EMAIL login
  document.getElementById("btnEmailLogin").onclick = async () => {
    const email = document.getElementById("inputEmail").value.trim();
    const pass = document.getElementById("inputEmailPass").value;

    if (!email || !pass) {
      Swal.fire("Error", "Email ‡¶ì Password ‡¶¶‡¶ø‡¶®", "error");
      return;
    }

    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;
      // find student by email
      const q = query(collection(db, "students"), where("email", "==", email));
      const snap = await getDocs(q);
      if (snap.empty) {
        // no student doc found for this email ‚Äî still logged in, but block
        Swal.fire("Error", "Student record not found for this email", "error");
        // optionally signOut here; but return
        return;
      }
      const studentId = snap.docs[0].id;
      await updateDoc(doc(db, "students", studentId), { authUid: uid });

      Swal.fire("Success", "Login Successful!", "success");
      setTimeout(() => {
        location.href = `student-dashboard.html?sid=${studentId}`;
      }, 800);

    } catch (err) {
      console.error(err);
      Swal.fire("Error", err.message || "Login failed", "error");
    }
  };

  // GOOGLE login
  document.getElementById("btnGoogle").onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      const res = await signInWithPopup(auth, provider);
      const user = res.user;
      const email = user.email;
      const uid = user.uid;

      // find student by email
      const q = query(collection(db, "students"), where("email", "==", email));
      const snap = await getDocs(q);
      if (snap.empty) {
        Swal.fire("Error", "Student record not found for this Google account", "error");
        return;
      }
      const studentId = snap.docs[0].id;
      await updateDoc(doc(db, "students", studentId), { authUid: uid });

      Swal.fire("Success", "Google Login Successful!", "success");
      setTimeout(() => {
        location.href = `student-dashboard.html?sid=${studentId}`;
      }, 800);

    } catch (err) {
      console.error(err);
      Swal.fire("Error", err.message || "Google login failed", "error");
    }
  };

</script>
</body>
</html>
