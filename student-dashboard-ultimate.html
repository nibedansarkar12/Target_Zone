<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Dashboard - Target Zone</title>

<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body {
    margin: 0;
    padding: 20px;
    background: radial-gradient(circle at top, #dbeafe, #e0f2fe, #ffffff);
    font-family: "Inter", sans-serif;
}
.glass-card {
    background: rgba(255, 255, 255, 0.72);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}
.sec-title {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 12px;
    background: linear-gradient(90deg, #4f46e5, #9333ea);
    -webkit-background-clip: text;
    color: transparent;
}
.table-box { overflow-x: auto; }
th { background: #4f46e5; color: white; padding: 10px; }
td { padding: 10px; border-bottom: 1px solid #e5e7eb; }
.examBtn {
    background: linear-gradient(90deg, #4f46e5, #9333ea);
    color: white; padding: 12px; width: 100%;
    font-size: 18px; border-radius: 14px; font-weight: 700;
    box-shadow: 0 8px 18px rgba(99, 102, 241, 0.3);
}
</style>
</head>

<body>

<div class="max-w-5xl mx-auto">

<h1 class="text-4xl font-extrabold text-center mb-6"
style="background:linear-gradient(90deg,#4f46e5,#9333ea);-webkit-background-clip:text;color:transparent;">
    ЁЯОУ Student Dashboard
</h1>

<!-- тЪая╕П LIMITED DASHBOARD NOTICE -->
<div id="limitedNotice" class="glass-card hidden mb-6 bg-yellow-100 border-l-4 border-yellow-500 p-4">
    <h2 class="text-xl font-bold text-yellow-700">ЁЯФТ Verification Needed</h2>
    <p>ржЖржкржирж╛рж░ ржмрзНржпржХрзНрждрж┐ржЧржд рждржерзНржп ржЖржкрж╛рждржд рж▓рзБржХрж╛ржирзЛ ржЖржЫрзЗред Verify ржХрж░рзЗ рждржерзНржп Unlock ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред</p>
    <a id="verifyBtn" class="text-blue-600 underline cursor-pointer">Verify Now</a>
</div>

<!-- STUDENT INFO -->
<div id="infoSection" class="glass-card hidden mb-6">
    <h2 class="sec-title">ЁЯУМ ржмрзНржпржХрзНрждрж┐ржЧржд рждржерзНржп</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p><strong>ржирж╛ржо:</strong> <span id="name"></span></p>
        <p><strong>ржлрзЛржи:</strong> <span id="phone"></span></p>
        <p><strong>ржЬржирзНржорждрж╛рж░рж┐ржЦ:</strong> <span id="dob"></span></p>
        <p><strong>ржкрж┐рждрж╛рж░ ржирж╛ржо:</strong> <span id="father"></span></p>
        <p><strong>ржмрзНржпрж╛ржЪ:</strong> <span id="batch"></span></p>
        <p><strong>рж╣рзЛржпрж╝рж╛ржЯрж╕ржЕрзНржпрж╛ржк:</strong> <span id="whatsapp"></span></p>
    </div>
</div>

<!-- PAYMENTS -->

<!-- PAYMENT SUMMARY -->
<div id="paymentSummary" class="glass-card hidden mb-6">
  <h2 class="sec-title">ЁЯУК ржкрзЗржорзЗржирзНржЯ рж╕рж╛рж░рж╛ржВрж╢</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div><strong>ржорзЛржЯ ржкрзЗржЗржб:</strong> тВ╣ <span id="totalPaid">0</span></div>
    <div><strong>ржкрзЗржЗржб ржорж╛рж╕:</strong> <span id="paidMonths">0</span></div>
    <div><strong>рж╢рзЗрж╖ ржкрзЗржорзЗржирзНржЯ:</strong> <span id="lastPayment">тАФ</span></div>
  </div>
</div>

<div id="paymentSection" class="glass-card hidden mb-6">
    <h2 class="sec-title">ЁЯТ░ ржкрзЗржорзЗржирзНржЯ рж╣рж┐рж╕рзНржЯрзНрж░рж┐</h2>

    <div class="table-box">
        <table class="w-full">
            <thead>
                <tr>
                    <th>рждрж╛рж░рж┐ржЦ</th>
                    <th>ржорж╛рж╕</th>
                    <th>ржЯрж╛ржХрж╛</th>
                </tr>
            </thead>
            <tbody id="paymentTable"></tbody>
        </table>
    </div>
</div>

<!-- Exam -->
<div id="examSection" class="glass-card mb-6">
    <h2 class="sec-title">ЁЯУЭ Exam</h2>
    <a href="quiz.html">
        <button class="examBtn">Go to Exam Page</button>
    </a>
</div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, collection, query, where, getDocs,
    doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
    getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyCR5rqthBh0vX0yLOcOG3b9xJiKbYtzdxU",
  authDomain: "target-zone-8fffd.firebaseapp.com",
  projectId: "target-zone-8fffd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

// LOAD DASHBOARD
window.onload = async () => {
    const url = new URL(window.location.href);
    const sid = url.searchParams.get("sid");  // Phone login case

    if (sid) {
        loadFullDashboard(sid);
        return;
    }

    onAuthStateChanged(auth, async (user) => {
        if (!user) return;

        const q = query(
            collection(db, "students"),
            where("email", "==", user.email)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
            showLimitedDashboard(user);
        } else {
            loadFullDashboard(snap.docs[0].id);
        }
    });
};

// LIMITED MODE
function showLimitedDashboard(user) {
    document.getElementById("limitedNotice").classList.remove("hidden");

    const email = user.email;
    const uid = user.uid;

    document.getElementById("verifyBtn").href =
        `verify.html?email=${email}&uid=${uid}`;
}

// FULL MODE
async function loadFullDashboard(sid) {
    const snap = await getDoc(doc(db, "students", sid));

    if (!snap.exists()) {
        Swal.fire("Error", "Student not found!");
        return;
    }

    const s = snap.data();

    // Personal Info
    document.getElementById("name").innerText = s.name || "N/A";
    document.getElementById("phone").innerText = s.phone || "N/A";
    document.getElementById("dob").innerText = s.dob || "N/A";
    document.getElementById("father").innerText = s.father || "N/A";
    
    // Batch name resolve (safe, no option removed)
    let batchName = "N/A";
    if (s.batch) {
        try {
            const batchSnap = await getDoc(doc(db, "batches", s.batch));
            if (batchSnap.exists()) {
                batchName = batchSnap.data().name || s.batch;
            } else {
                batchName = s.batch;
            }
        } catch (e) {
            batchName = s.batch;
        }
    }
    document.getElementById("batch").innerText = batchName;

    document.getElementById("whatsapp").innerText = s.whatsapp || "N/A";

    document.getElementById("infoSection").classList.remove("hidden");
    document.getElementById("paymentSection").classList.remove("hidden");

    // Payment Table Loading
    const table = document.getElementById("paymentTable");
    table.innerHTML = "";

    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    
    let totalPaid = 0;
    let paidCount = 0;
    let lastPayDate = "";

    months.forEach(m => {
        const p = s[m];
        if (!p) return;

        let dateText = "тАФ";
        let amountText = 0;

        if (typeof p === "object") {
            dateText = p.note || "тАФ";
            amountText = Number(p.amount || 0);
        } else {
            amountText = Number(p);
        }

        totalPaid += amountText;
        paidCount += 1;
        if (dateText && dateText !== "тАФ") lastPayDate = dateText;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${dateText}</td>
            <td>${m}</td>
            <td>тВ╣ ${amountText}</td>
        `;
        table.appendChild(tr);
    });

    if (paidCount === 0) {
        table.innerHTML = '<tr><td colspan="3" class="text-center">ржПржЦржирзЛ ржХрзЛржирзЛ ржкрзЗржорзЗржирзНржЯ ржирзЗржЗ</td></tr>';
    } else {
        document.getElementById("paymentSummary").classList.remove("hidden");
        document.getElementById("totalPaid").innerText = totalPaid;
        document.getElementById("paidMonths").innerText = paidCount;
        document.getElementById("lastPayment").innerText = lastPayDate || "тАФ";
    }
}
</script>

</body>
</html>
